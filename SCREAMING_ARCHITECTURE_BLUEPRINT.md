# ðŸ—ï¸ SCREAMING ARCHITECTURE BLUEPRINT
## Rust Terminal Forge - Rails-Inspired Structure

> **Generated by Architect Agent** - A comprehensive plan to restructure Rust Terminal Forge following Rails principles and "Screaming Architecture" patterns

---

## ðŸ“‹ EXECUTIVE SUMMARY

### Current State Analysis
The Rust Terminal Forge currently has a **mixed architecture** with server code scattered across different locations:
- `src/server.rs` - HTTP API server
- `src/pty_server.rs` - WebSocket PTY server  
- `pty-server.js` - Node.js alternative PTY server
- Frontend components mixed with backend concerns

### Target State Vision
Transform to a **Rails-inspired screaming architecture** where:
- **Features are obvious** from folder structure
- **Server concerns are centralized** in a dedicated module
- **Convention over configuration** reduces cognitive load
- **Separation of concerns** is crystal clear
- **DRY principles** eliminate code duplication

---

## ðŸŽ¯ ARCHITECTURAL PRINCIPLES

### 1. SCREAMING ARCHITECTURE
- **Feature directories** clearly communicate what the app does
- **Server module** makes backend concerns obvious
- **Mobile-first** structure reflects the app's primary use case
- **Test-driven** organization supports TDD workflows

### 2. RAILS CONVENTIONS
- **Convention over Configuration**: Standard patterns reduce decisions
- **DRY (Don't Repeat Yourself)**: Shared code through modules
- **Fat Models, Skinny Controllers**: Business logic in domain objects
- **Separation of Concerns**: Clear boundaries between layers

### 3. RUST ECOSYSTEM BEST PRACTICES
- **Workspace organization** for multi-binary projects
- **Feature-based modules** following Rust conventions
- **Error handling** with Result types and proper propagation
- **Async-first** design for high-performance terminal operations

---

## ðŸ“‚ NEW DIRECTORY STRUCTURE

```
rust-terminal-forge/
â”œâ”€â”€ ðŸš€ SERVER MODULE (NEW!)
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â”œâ”€â”€ mod.rs                    # Server module root
â”‚   â”‚   â”œâ”€â”€ Cargo.toml               # Workspace member
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ http/                    # HTTP API Server
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ handlers/            # Route handlers
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ health.rs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ execute.rs
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ static_files.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/          # HTTP middleware
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ cors.rs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ logging.rs
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ error_handling.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ routes.rs           # Route definitions
â”‚   â”‚   â”‚   â””â”€â”€ config.rs           # Server configuration
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ pty/                    # PTY/WebSocket Server
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ session.rs          # Terminal session management
â”‚   â”‚   â”‚   â”œâ”€â”€ websocket.rs        # WebSocket handling
â”‚   â”‚   â”‚   â”œâ”€â”€ command_processor.rs # Command execution
â”‚   â”‚   â”‚   â””â”€â”€ config.rs           # PTY configuration
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ shared/                 # Shared server code
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ types.rs            # Common server types
â”‚   â”‚   â”‚   â”œâ”€â”€ errors.rs           # Error definitions
â”‚   â”‚   â”‚   â”œâ”€â”€ logging.rs          # Logging utilities
â”‚   â”‚   â”‚   â””â”€â”€ security.rs         # Security utilities
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ bin/                    # Binary entry points
â”‚   â”‚   â”‚   â”œâ”€â”€ http_server.rs      # HTTP server main
â”‚   â”‚   â”‚   â””â”€â”€ pty_server.rs       # PTY server main
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ tests/                  # Server-specific tests
â”‚   â”‚       â”œâ”€â”€ integration/
â”‚   â”‚       â”‚   â”œâ”€â”€ http_api.rs
â”‚   â”‚       â”‚   â””â”€â”€ pty_websocket.rs
â”‚   â”‚       â””â”€â”€ unit/
â”‚   â”‚           â”œâ”€â”€ handlers.rs
â”‚   â”‚           â””â”€â”€ sessions.rs
â”‚
â”œâ”€â”€ ðŸŽ¨ FRONTEND MODULE (ENHANCED)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ app/                    # Application core
â”‚   â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ App.css
â”‚   â”‚   â”‚   â””â”€â”€ main.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ features/               # Feature-based organization
â”‚   â”‚   â”‚   â”œâ”€â”€ terminal/           # Terminal feature
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RealTerminal.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MultiTabTerminal.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AnsiText.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useTerminal.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useWebSocket.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TerminalService.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ WebSocketService.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ terminal.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ mobile/             # Mobile-specific features
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MobileTabBar.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GestureHandler.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useGestures.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useMobile.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ commands/           # Command system
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BaseCommandHandler.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FileSystemCommands.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SystemCommands.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RustCommands.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ClaudeCodeCommands.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ processors/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CommandProcessor.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SecureProcessor.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ registry/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CommandRegistry.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ ai/                 # AI Integration
â”‚   â”‚   â”‚       â”œâ”€â”€ providers/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ClaudeProvider.ts
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ GeminiProvider.ts
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ QwenProvider.ts
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ services/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ AIProviderRegistry.ts
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ UnifiedAICommandManager.ts
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ shared/                 # Shared frontend code
â”‚   â”‚   â”‚   â”œâ”€â”€ components/         # Reusable UI components
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ui/             # shadcn/ui components
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ErrorBoundary.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ThemeSwitcher.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/              # Shared hooks
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ use-toast.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useVisualViewport.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/                # Utilities
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ utils.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types/              # Shared types
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ common.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â””â”€â”€ services/           # Shared services
â”‚   â”‚   â”‚       â”œâ”€â”€ storage.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ validation.ts
â”‚   â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ legacy/                 # Gradual migration support
â”‚   â”‚       â”œâ”€â”€ core/               # Current core/ structure
â”‚   â”‚       â”œâ”€â”€ home/               # MVVM module (to be migrated)
â”‚   â”‚       â””â”€â”€ README.md           # Migration guide
â”‚
â”œâ”€â”€ ðŸ“ PROJECT ROOT (ORGANIZED)
â”‚   â”œâ”€â”€ Cargo.toml                  # Workspace root
â”‚   â”œâ”€â”€ package.json               # Frontend dependencies
â”‚   â”œâ”€â”€ Dockerfile                 # Container definition
â”‚   â”œâ”€â”€ docker-compose.yml         # Development environment
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                    # Configuration files
â”‚   â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â”‚   â”œâ”€â”€ tailwind.config.ts
â”‚   â”‚   â”œâ”€â”€ vitest.config.ts
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ scripts/                   # Development scripts
â”‚   â”‚   â”œâ”€â”€ start.sh
â”‚   â”‚   â”œâ”€â”€ dev-server.sh
â”‚   â”‚   â”œâ”€â”€ build.sh
â”‚   â”‚   â””â”€â”€ test.sh
â”‚   â”‚
â”‚   â”œâ”€â”€ docs/                      # Documentation
â”‚   â”‚   â”œâ”€â”€ ARCHITECTURE.md
â”‚   â”‚   â”œâ”€â”€ API.md
â”‚   â”‚   â”œâ”€â”€ DEVELOPMENT.md
â”‚   â”‚   â””â”€â”€ DEPLOYMENT.md
â”‚   â”‚
â”‚   â””â”€â”€ tests/                     # Integration tests
â”‚       â”œâ”€â”€ e2e/                   # End-to-end tests
â”‚       â”œâ”€â”€ integration/           # Integration tests
â”‚       â””â”€â”€ fixtures/              # Test data
```

---

## ðŸ”„ MIGRATION STRATEGY

### Phase 1: Server Module Creation (Week 1)
**Objective**: Create the new `server/` module without breaking existing functionality

#### Step 1.1: Create Server Module Structure
```bash
mkdir -p server/{http,pty,shared,bin,tests/{integration,unit}}
```

#### Step 1.2: Initialize Cargo Workspace
```toml
# Cargo.toml (root)
[workspace]
members = [
    "server",
]

# server/Cargo.toml
[package]
name = "server"
version = "0.1.0"
edition = "2021"

[[bin]]
name = "http_server"
path = "bin/http_server.rs"

[[bin]]
name = "pty_server" 
path = "bin/pty_server.rs"
```

#### Step 1.3: Migrate Server Code
- Move `src/server.rs` â†’ `server/bin/http_server.rs`
- Move `src/pty_server.rs` â†’ `server/bin/pty_server.rs`
- Extract shared code to `server/shared/`
- Create feature modules in `server/http/` and `server/pty/`

### Phase 2: Frontend Restructuring (Week 2)
**Objective**: Reorganize frontend code into feature-based modules

#### Step 2.1: Create Feature Modules
```bash
mkdir -p src/features/{terminal,mobile,commands,ai}
mkdir -p src/shared/{components,hooks,lib,types,services}
```

#### Step 2.2: Migrate by Feature
1. **Terminal Feature**: Move terminal-related components
2. **Mobile Feature**: Extract mobile-specific code
3. **Commands Feature**: Consolidate command handling
4. **AI Feature**: Organize AI provider code

#### Step 2.3: Create Legacy Bridge
- Keep current structure in `src/legacy/`
- Gradually migrate imports
- Maintain backward compatibility

### Phase 3: Testing & Documentation (Week 3)
**Objective**: Ensure comprehensive test coverage and documentation

#### Step 3.1: Server Testing
- Integration tests for HTTP API
- WebSocket connection tests
- Session management tests

#### Step 3.2: Frontend Testing
- Feature module tests
- Component integration tests
- E2E workflow tests

#### Step 3.3: Documentation Updates
- API documentation
- Architecture diagrams
- Development guides

---

## ðŸŽ¨ RAILS-INSPIRED CONVENTIONS

### 1. Naming Conventions
```
ðŸ—ï¸ Modules:     snake_case (http_server, pty_session)
ðŸ—ï¸ Files:       snake_case.rs (session_manager.rs)
ðŸ—ï¸ Types:       PascalCase (TerminalSession, CommandResult)
ðŸ—ï¸ Functions:   snake_case (create_session, handle_command)
ðŸ—ï¸ Constants:   SCREAMING_SNAKE_CASE (MAX_SESSIONS, DEFAULT_PORT)
```

### 2. Feature Organization
```
features/
â”œâ”€â”€ terminal/
â”‚   â”œâ”€â”€ components/    # UI components
â”‚   â”œâ”€â”€ hooks/         # React hooks
â”‚   â”œâ”€â”€ services/      # Business logic
â”‚   â”œâ”€â”€ types/         # TypeScript types
â”‚   â””â”€â”€ index.ts       # Public API
```

### 3. Error Handling
```rust
// Consistent error types across modules
#[derive(thiserror::Error, Debug)]
pub enum ServerError {
    #[error("Session not found: {id}")]
    SessionNotFound { id: String },
    
    #[error("WebSocket error: {0}")]
    WebSocket(#[from] tokio_tungstenite::tungstenite::Error),
    
    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),
}
```

### 4. Configuration Management
```rust
// server/shared/config.rs
#[derive(Debug, Clone)]
pub struct ServerConfig {
    pub http_port: u16,
    pub pty_port: u16,
    pub max_sessions: usize,
    pub session_timeout: Duration,
}

impl Default for ServerConfig {
    fn default() -> Self {
        Self {
            http_port: 3001,
            pty_port: 3002,
            max_sessions: 100,
            session_timeout: Duration::from_secs(3600),
        }
    }
}
```

---

## ðŸš¦ MIGRATION TIMELINE

### Week 1: Foundation
- [ ] Create `server/` module structure
- [ ] Set up Cargo workspace
- [ ] Migrate Rust server code
- [ ] Update build scripts and package.json
- [ ] Test server functionality

### Week 2: Frontend Refactoring
- [ ] Create feature module structure
- [ ] Migrate terminal components
- [ ] Migrate mobile components
- [ ] Migrate command system
- [ ] Migrate AI providers
- [ ] Update imports and dependencies

### Week 3: Quality & Polish
- [ ] Comprehensive testing
- [ ] Documentation updates
- [ ] Performance optimization
- [ ] Migration cleanup
- [ ] Remove legacy code

---

## ðŸ“Š BENEFITS OF NEW ARCHITECTURE

### ðŸŽ¯ Screaming Architecture Benefits
1. **Immediate Understanding**: New developers instantly understand the app structure
2. **Feature Isolation**: Terminal, mobile, and command features are clearly separated
3. **Server Clarity**: All backend concerns are in the `server/` module
4. **Test Organization**: Tests are co-located with features

### ðŸ›¤ï¸ Rails Convention Benefits  
1. **Reduced Cognitive Load**: Standard patterns reduce decision fatigue
2. **Faster Development**: Conventions guide implementation choices
3. **Easier Onboarding**: Familiar patterns for Rails developers
4. **Better Maintainability**: Consistent structure across modules

### âš¡ Performance Benefits
1. **Better Code Splitting**: Feature-based modules enable better bundling
2. **Lazy Loading**: Features can be loaded on demand
3. **Optimized Builds**: Clearer dependency graphs
4. **Improved Caching**: More granular cache invalidation

### ðŸ§ª Testing Benefits
1. **Feature-Focused Tests**: Tests align with business features
2. **Better Isolation**: Unit tests are more focused
3. **Comprehensive Coverage**: Clear test organization improves coverage
4. **Faster Test Execution**: Better test parallelization

---

## ðŸ”§ IMPLEMENTATION GUIDELINES

### Server Module Guidelines
```rust
// Use consistent module organization
pub mod handlers;    // Route handlers
pub mod middleware;  // HTTP middleware
pub mod services;    // Business logic
pub mod types;       // Data structures
pub mod config;      // Configuration
pub mod errors;      // Error definitions
```

### Frontend Feature Guidelines
```typescript
// Each feature exports a clean API
export { default as TerminalComponent } from './components';
export * from './hooks';
export * from './services'; 
export * from './types';
```

### Testing Guidelines
```rust
// Co-located tests with clear naming
#[cfg(test)]
mod tests {
    use super::*;
    
    #[tokio::test]
    async fn test_session_creation() {
        // Test implementation
    }
}
```

---

## âš ï¸ MIGRATION RISKS & MITIGATION

### Risk 1: Breaking Changes
**Mitigation**: 
- Maintain legacy compatibility during migration
- Gradual migration with feature flags
- Comprehensive integration testing

### Risk 2: Performance Regression
**Mitigation**:
- Performance benchmarks before/after
- Gradual rollout with monitoring
- Rollback plan if performance degrades

### Risk 3: Development Disruption
**Mitigation**:
- Clear migration timeline
- Feature branches for major changes
- Regular team sync during migration

---

## ðŸŽ‰ SUCCESS METRICS

### Code Quality Metrics
- [ ] Reduced cyclomatic complexity
- [ ] Improved test coverage (>90%)
- [ ] Fewer linting violations
- [ ] Better TypeScript strict mode compliance

### Developer Experience Metrics
- [ ] Faster onboarding for new developers
- [ ] Reduced time to implement new features
- [ ] Fewer "where should this code go?" questions
- [ ] Improved IDE/tooling support

### Performance Metrics
- [ ] Faster build times
- [ ] Smaller bundle sizes
- [ ] Better runtime performance
- [ ] Reduced memory usage

---

## ðŸ“š NEXT STEPS

1. **Review & Approval**: Get team/stakeholder approval for migration plan
2. **Resource Planning**: Assign developers and allocate time
3. **Environment Setup**: Prepare development and testing environments
4. **Phase 1 Implementation**: Begin with server module creation
5. **Continuous Monitoring**: Track progress and adjust timeline as needed

---

> **Generated by Architect Agent** - This blueprint provides a comprehensive roadmap for transforming Rust Terminal Forge into a Rails-inspired screaming architecture that emphasizes clarity, maintainability, and developer productivity.

---

*Last Updated: 2025-07-25*
*Next Review: Weekly during migration*