# 🏗️ SCREAMING ARCHITECTURE BLUEPRINT
## Rust Terminal Forge - Rails-Inspired Structure

> **Generated by Architect Agent** - A comprehensive plan to restructure Rust Terminal Forge following Rails principles and "Screaming Architecture" patterns

---

## 📋 EXECUTIVE SUMMARY

### Current State Analysis
The Rust Terminal Forge currently has a **mixed architecture** with server code scattered across different locations:
- `src/server.rs` - HTTP API server
- `src/pty_server.rs` - WebSocket PTY server  
- `pty-server.js` - Node.js alternative PTY server
- Frontend components mixed with backend concerns

### Target State Vision
Transform to a **Rails-inspired screaming architecture** where:
- **Features are obvious** from folder structure
- **Server concerns are centralized** in a dedicated module
- **Convention over configuration** reduces cognitive load
- **Separation of concerns** is crystal clear
- **DRY principles** eliminate code duplication

---

## 🎯 ARCHITECTURAL PRINCIPLES

### 1. SCREAMING ARCHITECTURE
- **Feature directories** clearly communicate what the app does
- **Server module** makes backend concerns obvious
- **Mobile-first** structure reflects the app's primary use case
- **Test-driven** organization supports TDD workflows

### 2. RAILS CONVENTIONS
- **Convention over Configuration**: Standard patterns reduce decisions
- **DRY (Don't Repeat Yourself)**: Shared code through modules
- **Fat Models, Skinny Controllers**: Business logic in domain objects
- **Separation of Concerns**: Clear boundaries between layers

### 3. RUST ECOSYSTEM BEST PRACTICES
- **Workspace organization** for multi-binary projects
- **Feature-based modules** following Rust conventions
- **Error handling** with Result types and proper propagation
- **Async-first** design for high-performance terminal operations

---

## 📂 NEW DIRECTORY STRUCTURE

```
rust-terminal-forge/
├── 🚀 SERVER MODULE (NEW!)
│   ├── server/
│   │   ├── mod.rs                    # Server module root
│   │   ├── Cargo.toml               # Workspace member
│   │   │
│   │   ├── http/                    # HTTP API Server
│   │   │   ├── mod.rs
│   │   │   ├── handlers/            # Route handlers
│   │   │   │   ├── mod.rs
│   │   │   │   ├── health.rs
│   │   │   │   ├── execute.rs
│   │   │   │   └── static_files.rs
│   │   │   ├── middleware/          # HTTP middleware
│   │   │   │   ├── mod.rs
│   │   │   │   ├── cors.rs
│   │   │   │   ├── logging.rs
│   │   │   │   └── error_handling.rs
│   │   │   ├── routes.rs           # Route definitions
│   │   │   └── config.rs           # Server configuration
│   │   │
│   │   ├── pty/                    # PTY/WebSocket Server
│   │   │   ├── mod.rs
│   │   │   ├── session.rs          # Terminal session management
│   │   │   ├── websocket.rs        # WebSocket handling
│   │   │   ├── command_processor.rs # Command execution
│   │   │   └── config.rs           # PTY configuration
│   │   │
│   │   ├── shared/                 # Shared server code
│   │   │   ├── mod.rs
│   │   │   ├── types.rs            # Common server types
│   │   │   ├── errors.rs           # Error definitions
│   │   │   ├── logging.rs          # Logging utilities
│   │   │   └── security.rs         # Security utilities
│   │   │
│   │   ├── bin/                    # Binary entry points
│   │   │   ├── http_server.rs      # HTTP server main
│   │   │   └── pty_server.rs       # PTY server main
│   │   │
│   │   └── tests/                  # Server-specific tests
│   │       ├── integration/
│   │       │   ├── http_api.rs
│   │       │   └── pty_websocket.rs
│   │       └── unit/
│   │           ├── handlers.rs
│   │           └── sessions.rs
│
├── 🎨 FRONTEND MODULE (ENHANCED)
│   ├── src/
│   │   ├── app/                    # Application core
│   │   │   ├── App.tsx
│   │   │   ├── App.css
│   │   │   └── main.tsx
│   │   │
│   │   ├── features/               # Feature-based organization
│   │   │   ├── terminal/           # Terminal feature
│   │   │   │   ├── components/
│   │   │   │   │   ├── RealTerminal.tsx
│   │   │   │   │   ├── MultiTabTerminal.tsx
│   │   │   │   │   ├── AnsiText.tsx
│   │   │   │   │   └── index.ts
│   │   │   │   ├── hooks/
│   │   │   │   │   ├── useTerminal.ts
│   │   │   │   │   ├── useWebSocket.ts
│   │   │   │   │   └── index.ts
│   │   │   │   ├── services/
│   │   │   │   │   ├── TerminalService.ts
│   │   │   │   │   ├── WebSocketService.ts
│   │   │   │   │   └── index.ts
│   │   │   │   ├── types/
│   │   │   │   │   ├── terminal.ts
│   │   │   │   │   └── index.ts
│   │   │   │   └── index.ts
│   │   │   │
│   │   │   ├── mobile/             # Mobile-specific features
│   │   │   │   ├── components/
│   │   │   │   │   ├── MobileTabBar.tsx
│   │   │   │   │   ├── GestureHandler.tsx
│   │   │   │   │   └── index.ts
│   │   │   │   ├── hooks/
│   │   │   │   │   ├── useGestures.ts
│   │   │   │   │   ├── useMobile.tsx
│   │   │   │   │   └── index.ts
│   │   │   │   └── index.ts
│   │   │   │
│   │   │   ├── commands/           # Command system
│   │   │   │   ├── handlers/
│   │   │   │   │   ├── BaseCommandHandler.ts
│   │   │   │   │   ├── FileSystemCommands.ts
│   │   │   │   │   ├── SystemCommands.ts
│   │   │   │   │   ├── RustCommands.ts
│   │   │   │   │   ├── ClaudeCodeCommands.ts
│   │   │   │   │   └── index.ts
│   │   │   │   ├── processors/
│   │   │   │   │   ├── CommandProcessor.ts
│   │   │   │   │   ├── SecureProcessor.ts
│   │   │   │   │   └── index.ts
│   │   │   │   ├── registry/
│   │   │   │   │   ├── CommandRegistry.ts
│   │   │   │   │   └── index.ts
│   │   │   │   └── index.ts
│   │   │   │
│   │   │   └── ai/                 # AI Integration
│   │   │       ├── providers/
│   │   │       │   ├── ClaudeProvider.ts
│   │   │       │   ├── GeminiProvider.ts
│   │   │       │   ├── QwenProvider.ts
│   │   │       │   └── index.ts
│   │   │       ├── services/
│   │   │       │   ├── AIProviderRegistry.ts
│   │   │       │   ├── UnifiedAICommandManager.ts
│   │   │       │   └── index.ts
│   │   │       └── index.ts
│   │   │
│   │   ├── shared/                 # Shared frontend code
│   │   │   ├── components/         # Reusable UI components
│   │   │   │   ├── ui/             # shadcn/ui components
│   │   │   │   ├── ErrorBoundary.tsx
│   │   │   │   ├── ThemeSwitcher.tsx
│   │   │   │   └── index.ts
│   │   │   ├── hooks/              # Shared hooks
│   │   │   │   ├── use-toast.ts
│   │   │   │   ├── useVisualViewport.tsx
│   │   │   │   └── index.ts
│   │   │   ├── lib/                # Utilities
│   │   │   │   ├── utils.ts
│   │   │   │   └── index.ts
│   │   │   ├── types/              # Shared types
│   │   │   │   ├── common.ts
│   │   │   │   └── index.ts
│   │   │   └── services/           # Shared services
│   │   │       ├── storage.ts
│   │   │       ├── validation.ts
│   │   │       └── index.ts
│   │   │
│   │   └── legacy/                 # Gradual migration support
│   │       ├── core/               # Current core/ structure
│   │       ├── home/               # MVVM module (to be migrated)
│   │       └── README.md           # Migration guide
│
├── 📁 PROJECT ROOT (ORGANIZED)
│   ├── Cargo.toml                  # Workspace root
│   ├── package.json               # Frontend dependencies
│   ├── Dockerfile                 # Container definition
│   ├── docker-compose.yml         # Development environment
│   │
│   ├── config/                    # Configuration files
│   │   ├── vite.config.ts
│   │   ├── tailwind.config.ts
│   │   ├── vitest.config.ts
│   │   └── tsconfig.json
│   │
│   ├── scripts/                   # Development scripts
│   │   ├── start.sh
│   │   ├── dev-server.sh
│   │   ├── build.sh
│   │   └── test.sh
│   │
│   ├── docs/                      # Documentation
│   │   ├── ARCHITECTURE.md
│   │   ├── API.md
│   │   ├── DEVELOPMENT.md
│   │   └── DEPLOYMENT.md
│   │
│   └── tests/                     # Integration tests
│       ├── e2e/                   # End-to-end tests
│       ├── integration/           # Integration tests
│       └── fixtures/              # Test data
```

---

## 🔄 MIGRATION STRATEGY

### Phase 1: Server Module Creation (Week 1)
**Objective**: Create the new `server/` module without breaking existing functionality

#### Step 1.1: Create Server Module Structure
```bash
mkdir -p server/{http,pty,shared,bin,tests/{integration,unit}}
```

#### Step 1.2: Initialize Cargo Workspace
```toml
# Cargo.toml (root)
[workspace]
members = [
    "server",
]

# server/Cargo.toml
[package]
name = "server"
version = "0.1.0"
edition = "2021"

[[bin]]
name = "http_server"
path = "bin/http_server.rs"

[[bin]]
name = "pty_server" 
path = "bin/pty_server.rs"
```

#### Step 1.3: Migrate Server Code
- Move `src/server.rs` → `server/bin/http_server.rs`
- Move `src/pty_server.rs` → `server/bin/pty_server.rs`
- Extract shared code to `server/shared/`
- Create feature modules in `server/http/` and `server/pty/`

### Phase 2: Frontend Restructuring (Week 2)
**Objective**: Reorganize frontend code into feature-based modules

#### Step 2.1: Create Feature Modules
```bash
mkdir -p src/features/{terminal,mobile,commands,ai}
mkdir -p src/shared/{components,hooks,lib,types,services}
```

#### Step 2.2: Migrate by Feature
1. **Terminal Feature**: Move terminal-related components
2. **Mobile Feature**: Extract mobile-specific code
3. **Commands Feature**: Consolidate command handling
4. **AI Feature**: Organize AI provider code

#### Step 2.3: Create Legacy Bridge
- Keep current structure in `src/legacy/`
- Gradually migrate imports
- Maintain backward compatibility

### Phase 3: Testing & Documentation (Week 3)
**Objective**: Ensure comprehensive test coverage and documentation

#### Step 3.1: Server Testing
- Integration tests for HTTP API
- WebSocket connection tests
- Session management tests

#### Step 3.2: Frontend Testing
- Feature module tests
- Component integration tests
- E2E workflow tests

#### Step 3.3: Documentation Updates
- API documentation
- Architecture diagrams
- Development guides

---

## 🎨 RAILS-INSPIRED CONVENTIONS

### 1. Naming Conventions
```
🏗️ Modules:     snake_case (http_server, pty_session)
🏗️ Files:       snake_case.rs (session_manager.rs)
🏗️ Types:       PascalCase (TerminalSession, CommandResult)
🏗️ Functions:   snake_case (create_session, handle_command)
🏗️ Constants:   SCREAMING_SNAKE_CASE (MAX_SESSIONS, DEFAULT_PORT)
```

### 2. Feature Organization
```
features/
├── terminal/
│   ├── components/    # UI components
│   ├── hooks/         # React hooks
│   ├── services/      # Business logic
│   ├── types/         # TypeScript types
│   └── index.ts       # Public API
```

### 3. Error Handling
```rust
// Consistent error types across modules
#[derive(thiserror::Error, Debug)]
pub enum ServerError {
    #[error("Session not found: {id}")]
    SessionNotFound { id: String },
    
    #[error("WebSocket error: {0}")]
    WebSocket(#[from] tokio_tungstenite::tungstenite::Error),
    
    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),
}
```

### 4. Configuration Management
```rust
// server/shared/config.rs
#[derive(Debug, Clone)]
pub struct ServerConfig {
    pub http_port: u16,
    pub pty_port: u16,
    pub max_sessions: usize,
    pub session_timeout: Duration,
}

impl Default for ServerConfig {
    fn default() -> Self {
        Self {
            http_port: 3001,
            pty_port: 3002,
            max_sessions: 100,
            session_timeout: Duration::from_secs(3600),
        }
    }
}
```

---

## 🚦 MIGRATION TIMELINE

### Week 1: Foundation
- [ ] Create `server/` module structure
- [ ] Set up Cargo workspace
- [ ] Migrate Rust server code
- [ ] Update build scripts and package.json
- [ ] Test server functionality

### Week 2: Frontend Refactoring
- [ ] Create feature module structure
- [ ] Migrate terminal components
- [ ] Migrate mobile components
- [ ] Migrate command system
- [ ] Migrate AI providers
- [ ] Update imports and dependencies

### Week 3: Quality & Polish
- [ ] Comprehensive testing
- [ ] Documentation updates
- [ ] Performance optimization
- [ ] Migration cleanup
- [ ] Remove legacy code

---

## 📊 BENEFITS OF NEW ARCHITECTURE

### 🎯 Screaming Architecture Benefits
1. **Immediate Understanding**: New developers instantly understand the app structure
2. **Feature Isolation**: Terminal, mobile, and command features are clearly separated
3. **Server Clarity**: All backend concerns are in the `server/` module
4. **Test Organization**: Tests are co-located with features

### 🛤️ Rails Convention Benefits  
1. **Reduced Cognitive Load**: Standard patterns reduce decision fatigue
2. **Faster Development**: Conventions guide implementation choices
3. **Easier Onboarding**: Familiar patterns for Rails developers
4. **Better Maintainability**: Consistent structure across modules

### ⚡ Performance Benefits
1. **Better Code Splitting**: Feature-based modules enable better bundling
2. **Lazy Loading**: Features can be loaded on demand
3. **Optimized Builds**: Clearer dependency graphs
4. **Improved Caching**: More granular cache invalidation

### 🧪 Testing Benefits
1. **Feature-Focused Tests**: Tests align with business features
2. **Better Isolation**: Unit tests are more focused
3. **Comprehensive Coverage**: Clear test organization improves coverage
4. **Faster Test Execution**: Better test parallelization

---

## 🔧 IMPLEMENTATION GUIDELINES

### Server Module Guidelines
```rust
// Use consistent module organization
pub mod handlers;    // Route handlers
pub mod middleware;  // HTTP middleware
pub mod services;    // Business logic
pub mod types;       // Data structures
pub mod config;      // Configuration
pub mod errors;      // Error definitions
```

### Frontend Feature Guidelines
```typescript
// Each feature exports a clean API
export { default as TerminalComponent } from './components';
export * from './hooks';
export * from './services'; 
export * from './types';
```

### Testing Guidelines
```rust
// Co-located tests with clear naming
#[cfg(test)]
mod tests {
    use super::*;
    
    #[tokio::test]
    async fn test_session_creation() {
        // Test implementation
    }
}
```

---

## ⚠️ MIGRATION RISKS & MITIGATION

### Risk 1: Breaking Changes
**Mitigation**: 
- Maintain legacy compatibility during migration
- Gradual migration with feature flags
- Comprehensive integration testing

### Risk 2: Performance Regression
**Mitigation**:
- Performance benchmarks before/after
- Gradual rollout with monitoring
- Rollback plan if performance degrades

### Risk 3: Development Disruption
**Mitigation**:
- Clear migration timeline
- Feature branches for major changes
- Regular team sync during migration

---

## 🎉 SUCCESS METRICS

### Code Quality Metrics
- [ ] Reduced cyclomatic complexity
- [ ] Improved test coverage (>90%)
- [ ] Fewer linting violations
- [ ] Better TypeScript strict mode compliance

### Developer Experience Metrics
- [ ] Faster onboarding for new developers
- [ ] Reduced time to implement new features
- [ ] Fewer "where should this code go?" questions
- [ ] Improved IDE/tooling support

### Performance Metrics
- [ ] Faster build times
- [ ] Smaller bundle sizes
- [ ] Better runtime performance
- [ ] Reduced memory usage

---

## 📚 NEXT STEPS

1. **Review & Approval**: Get team/stakeholder approval for migration plan
2. **Resource Planning**: Assign developers and allocate time
3. **Environment Setup**: Prepare development and testing environments
4. **Phase 1 Implementation**: Begin with server module creation
5. **Continuous Monitoring**: Track progress and adjust timeline as needed

---

> **Generated by Architect Agent** - This blueprint provides a comprehensive roadmap for transforming Rust Terminal Forge into a Rails-inspired screaming architecture that emphasizes clarity, maintainability, and developer productivity.

---

*Last Updated: 2025-07-25*
*Next Review: Weekly during migration*